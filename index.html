<script>
let CFG = { API_BASE: "" };
let accessToken = null;
async function loadConfig() {
  const r = await fetch("./assets/config.json", { cache: "no-store" });
  CFG = await r.json();
}

// Get short-lived token (no hardcoded keys in the browser!)
async function getToken() {
  // Option A: anonymous session token with strict rate limits/captcha
  // Option B: email magic link or code sent to user (safer)
  const r = await fetch(`${CFG.API_BASE}/auth/token`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ mode: "anon" })
  });
  if (!r.ok) throw new Error("Auth failed");
  const data = await r.json();
  accessToken = data.token;           // expires in ~5â€“15 min on the server
  setTimeout(()=>accessToken=null, (data.expires_in-5)*1000);
}

async function api(path, opts={}) {
  if (!accessToken) await getToken();
  const r = await fetch(`${CFG.API_BASE}${path}`, {
    ...opts,
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${accessToken}`,
      ...(opts.headers||{})
    }
  });
  if (!r.ok) throw new Error(await r.text());
  return r.headers.get("content-type")?.includes("application/json") ? r.json() : r.text();
}

// Example: invoke an agent from a button
async function runProtoKernelDemo(payload) {
  try {
    const res = await api("/agents/invoke", {
      method: "POST",
      body: JSON.stringify({
        agent: "proto-kernel-lite",
        input: payload
      })
    });
    return res; // { taskId, result?, status }
  } catch (e) {
    console.error(e);
    alert("Service temporarily unavailable. Please try again.");
  }
}

// Example: queue a task and poll
async function queueComplianceAudit(form) {
  const task = await api("/tasks", {
    method: "POST",
    body: JSON.stringify({
      kind: "compliance_audit",
      data: Object.fromEntries(new FormData(form))
    })
  });
  const id = task.id;
  // Poll status (or use SSE below)
  let tries = 0;
  while (tries++ < 30) {
    const s = await api(`/tasks/${id}`, { method: "GET" });
    if (s.status === "done") return s;
    if (s.status === "error") throw new Error(s.error);
    await new Promise(r=>setTimeout(r, 2000));
  }
  throw new Error("Timeout");
}

// Optional: live logs via SSE
function subscribeEvents(taskId, onMsg) {
  if (!accessToken) return; // ensure token initialized
  const es = new EventSource(`${CFG.API_BASE}/events/stream?task=${taskId}&token=${accessToken}`);
  es.onmessage = (ev)=> onMsg(JSON.parse(ev.data));
  es.onerror = ()=> es.close();
  return ()=> es.close();
}

// Boot
(async ()=>{
  await loadConfig();
  // wire up buttons if present
  const demoBtn = document.querySelector("#demoBtn");
  if (demoBtn) demoBtn.addEventListener("click", async ()=>{
    demoBtn.disabled = true;
    const out = await runProtoKernelDemo({ prompt: "Hello MeshHubOS Lite" });
    document.querySelector("#demoOut").textContent = JSON.stringify(out,null,2);
    demoBtn.disabled = false;
  });

  const auditForm = document.querySelector("#auditForm");
  if (auditForm) auditForm.addEventListener("submit", async (e)=>{
    e.preventDefault();
    const res = await queueComplianceAudit(auditForm);
    document.querySelector("#auditOut").textContent = JSON.stringify(res,null,2);
  });
})();
</script>